# atakora deploy

**Navigation**: [Docs Home](../../README.md) > [Reference](../README.md) > [CLI Reference](./README.md) > deploy

---

## Synopsis

```bash
atakora deploy [options]
```

## Description

Deploys ARM templates to Azure, creating or updating infrastructure resources. This command authenticates with Azure, validates templates, creates deployments, and monitors their progress.

Deployment is the final step that provisions your infrastructure in Azure based on the ARM templates generated by [`synth`](./synth.md).

## What Deployment Does

1. **Authenticates**: Verifies Azure credentials
2. **Synthesizes**: Generates ARM templates (if needed)
3. **Validates**: Azure-side template validation
4. **Creates Deployment**: Submits to Azure Resource Manager
5. **Monitors Progress**: Tracks deployment status
6. **Reports Results**: Shows created/updated resources

## Options

### `--package <name>`

Deploy a specific package.

- **Type**: string
- **Default**: Default package from manifest
- **Example**: `--package production`

### `--subscription <id>`

Azure subscription ID to deploy to.

- **Type**: string (UUID)
- **Default**: From config or `AZURE_SUBSCRIPTION_ID` environment variable
- **Example**: `--subscription 00000000-0000-0000-0000-000000000000`

### `--resource-group <name>`

Target resource group (for resource group scoped deployments).

- **Type**: string
- **Default**: Resource group defined in code
- **Example**: `--resource-group rg-production`

### `--mode <mode>`

Deployment mode.

- **Type**: string
- **Values**: `incremental`, `complete`
- **Default**: `incremental`
- **Example**: `--mode complete`

Modes:
- **incremental**: Add/update resources, don't delete existing
- **complete**: Delete resources not in template (dangerous!)

### `--confirm / --no-confirm`

Prompt for confirmation before deploying.

- **Type**: boolean
- **Default**: `true` (prompt)
- **Example**: `--no-confirm` for automated deployments

### `--verbose`

Show detailed deployment output.

- **Type**: boolean (flag)
- **Default**: `false`
- **Example**: `atakora deploy --verbose`

### `--dry-run`

Validate deployment without making changes.

- **Type**: boolean (flag)
- **Default**: `false`
- **Example**: `atakora deploy --dry-run`

Runs Azure template validation but doesn't deploy.

### `--wait / --no-wait`

Wait for deployment to complete.

- **Type**: boolean
- **Default**: `true` (wait)
- **Example**: `--no-wait` to deploy asynchronously

### `--timeout <seconds>`

Maximum time to wait for deployment.

- **Type**: number
- **Default**: `3600` (1 hour)
- **Example**: `--timeout 7200`

## Examples

### Basic Deployment

Deploy default package:

```bash
atakora deploy
```

Output:
```
Deploying package: backend
Subscription: Production (00000000-0000-0000-0000-000000000000)

Resources to deploy:
  + Microsoft.Resources/resourceGroups          rg-backend-prod-eastus
  + Microsoft.Network/virtualNetworks           vnet-backend-prod-eastus
  + Microsoft.Storage/storageAccounts           stbackendprod

Continue with deployment? (Y/n) y

Deploying...
✓ Resource group deployment created
  Deployment ID: deployment-20251008-120000

Progress:
  [========================================] 100%

✓ Deployment succeeded
  Duration: 2m 34s
  Resources created: 3
  Resources updated: 0
```

### Deploy Specific Package

```bash
atakora deploy --package production
```

### Deploy Without Confirmation

For CI/CD pipelines:

```bash
atakora deploy --no-confirm
```

### Dry Run Validation

Validate without deploying:

```bash
atakora deploy --dry-run
```

Output:
```
Validating deployment: backend

✓ Template validation passed
✓ No deployment errors detected

What would be deployed:
  + Microsoft.Resources/resourceGroups          rg-backend-prod-eastus
  + Microsoft.Network/virtualNetworks           vnet-backend-prod-eastus
  + Microsoft.Storage/storageAccounts           stbackendprod

No changes were made (--dry-run)
```

### Verbose Deployment

See detailed Azure API interactions:

```bash
atakora deploy --verbose
```

Output:
```
[INFO] Starting deployment for package: backend
[DEBUG] Loading Azure credentials from config
[DEBUG] Subscription ID: 00000000-0000-0000-0000-000000000000
[DEBUG] Tenant ID: 11111111-1111-1111-1111-111111111111
[INFO] Authenticated as: myapp@example.com
[DEBUG] Reading template: .atakora/arm.out/backend/template.json
[DEBUG] Template size: 45.2 KB
[DEBUG] Resources in template: 3
[INFO] Creating deployment: deployment-20251008-120000
[DEBUG] Deployment mode: Incremental
[DEBUG] API request: PUT /subscriptions/.../deployments/...
[DEBUG] Response status: 201 Created
[INFO] Deployment created successfully
[DEBUG] Polling deployment status every 5 seconds
[DEBUG] Status: Running (0% complete)
[DEBUG] Current operation: Creating resource group
[DEBUG] Status: Running (33% complete)
[DEBUG] Current operation: Creating virtual network
[DEBUG] Status: Running (66% complete)
[DEBUG] Current operation: Creating storage account
[DEBUG] Status: Succeeded (100% complete)
[INFO] Deployment completed successfully
[INFO] Duration: 2m 34s
```

### Deploy to Specific Subscription

```bash
atakora deploy \
  --package production \
  --subscription 22222222-2222-2222-2222-222222222222
```

### Complete Mode Deployment

**Warning**: Deletes resources not in template!

```bash
atakora deploy --mode complete
```

Confirmation prompt:
```
WARNING: Complete mode will DELETE resources not defined in your template!

Are you absolutely sure? Type 'delete resources' to confirm:
```

### Async Deployment

Deploy without waiting for completion:

```bash
atakora deploy --no-wait
```

Output:
```
Deployment started: deployment-20251008-120000
Monitor status:
  az deployment group show \
    --name deployment-20251008-120000 \
    --resource-group rg-backend-prod-eastus
```

### Custom Timeout

Wait longer for large deployments:

```bash
atakora deploy --timeout 7200  # 2 hours
```

## Authentication

### Methods

Atakora supports multiple authentication methods:

1. **Service Principal** (recommended for CI/CD)
2. **Azure CLI** (recommended for local development)
3. **Managed Identity** (for Azure-hosted deployments)

### Service Principal

Environment variables:

```bash
export AZURE_TENANT_ID="00000000-0000-0000-0000-000000000000"
export AZURE_CLIENT_ID="11111111-1111-1111-1111-111111111111"
export AZURE_CLIENT_SECRET="secret-value"
export AZURE_SUBSCRIPTION_ID="22222222-2222-2222-2222-222222222222"

atakora deploy
```

Or using config:

```bash
atakora config set-credentials
atakora deploy
```

### Azure CLI

Login first:

```bash
az login
az account set --subscription "Production"

atakora deploy
```

### Managed Identity

For Azure-hosted CI/CD:

```bash
# Enable managed identity in Azure DevOps or GitHub Actions
atakora deploy  # Automatically uses managed identity
```

## Deployment Output

### Success Output

```
✓ Deployment succeeded
  Duration: 2m 34s
  Resources created: 3
  Resources updated: 0

Created resources:
  Microsoft.Resources/resourceGroups
    rg-backend-prod-eastus

  Microsoft.Network/virtualNetworks
    vnet-backend-prod-eastus
    ID: /subscriptions/.../resourceGroups/.../providers/Microsoft.Network/virtualNetworks/vnet-backend-prod-eastus

  Microsoft.Storage/storageAccounts
    stbackendprod
    ID: /subscriptions/.../resourceGroups/.../providers/Microsoft.Storage/storageAccounts/stbackendprod
    Primary Endpoint: https://stbackendprod.blob.core.windows.net/
```

### Error Output

```
✗ Deployment failed
  Duration: 1m 12s
  Status: Failed
  Error: StorageAccountAlreadyTaken

Details:
  Resource: Microsoft.Storage/storageAccounts 'stbackendprod'
  Error: The storage account name 'stbackendprod' is already taken.
  Code: StorageAccountAlreadyTaken

Suggestion:
  Change the storage account name in your code or delete the existing account.
```

### Warning Output

```
⚠ Deployment succeeded with warnings
  Duration: 3m 45s
  Resources created: 5
  Resources updated: 2
  Warnings: 1

Warnings:
  Microsoft.Network/virtualNetworks 'vnet-backend-prod-eastus'
    Warning: Changing address space may cause downtime
```

## Exit Codes

| Code | Condition | Next Steps |
|------|-----------|------------|
| 0 | Deployment succeeded | Verify resources in Azure Portal |
| 1 | General error | Check error message |
| 2 | Authentication failed | Fix credentials with `atakora config` |
| 3 | Template validation failed | Fix template errors |
| 4 | Deployment failed | Review Azure error details |
| 5 | Timeout | Increase timeout or check Azure status |

## Common Issues

### Authentication Failures

**Error**:
```
Error: Authentication failed
InvalidAuthenticationToken: The access token is invalid
```

**Causes & Solutions**:

1. **No credentials configured**:
   ```bash
   atakora config set-credentials
   ```

2. **Expired Azure CLI token**:
   ```bash
   az login
   az account set --subscription "Production"
   ```

3. **Invalid service principal**:
   ```bash
   # Verify credentials
   az login --service-principal \
     --username $AZURE_CLIENT_ID \
     --password $AZURE_CLIENT_SECRET \
     --tenant $AZURE_TENANT_ID
   ```

### Template Validation Errors

**Error**:
```
Template validation failed:
  InvalidTemplate: Deployment template validation failed
```

**Solution**: Synthesize with validation first:
```bash
atakora synth  # Validates locally
atakora deploy
```

### Resource Already Exists

**Error**:
```
StorageAccountAlreadyTaken: The storage account 'stbackendprod' is already taken
```

**Solutions**:

1. **Use different name**:
   ```typescript
   const storage = new StorageAccount(this, 'Storage', {
     // Auto-generates unique name
     resourceGroup: rg
   });
   ```

2. **Delete existing resource**:
   ```bash
   az storage account delete \
     --name stbackendprod \
     --resource-group rg-backend-prod-eastus
   ```

3. **Import existing resource** (future feature)

### Permission Denied

**Error**:
```
AuthorizationFailed: You do not have permission to perform action
'Microsoft.Resources/deployments/write'
```

**Solution**: Request appropriate Azure RBAC role:
```bash
# Needs Contributor or Owner on subscription
az role assignment create \
  --role Contributor \
  --assignee <user-or-sp> \
  --subscription $AZURE_SUBSCRIPTION_ID
```

### Deployment Timeout

**Error**:
```
Deployment timed out after 3600 seconds
```

**Solutions**:

1. **Increase timeout**:
   ```bash
   atakora deploy --timeout 7200
   ```

2. **Deploy without waiting**:
   ```bash
   atakora deploy --no-wait
   ```

3. **Check Azure Portal** for deployment status

## Best Practices

### Pre-Deployment Validation

Always validate before deploying:

```bash
# 1. Synthesize with validation
atakora synth

# 2. Review changes
atakora diff

# 3. Dry run validation
atakora deploy --dry-run

# 4. Deploy
atakora deploy
```

### Use Confirmation in Production

Never use `--no-confirm` for production:

```bash
# Development/staging
atakora deploy --package dev --no-confirm

# Production
atakora deploy --package production
# Prompts for confirmation
```

### Monitor Deployments

Watch deployment progress:

```bash
# Terminal 1: Deploy
atakora deploy --verbose

# Terminal 2: Monitor in Azure
az deployment group list \
  --resource-group rg-backend-prod-eastus \
  --output table
```

### Handle Failed Deployments

If deployment fails:

1. **Review error details**:
   ```bash
   atakora deploy --verbose > deploy.log 2>&1
   cat deploy.log
   ```

2. **Check Azure deployment status**:
   ```bash
   az deployment group show \
     --name deployment-20251008-120000 \
     --resource-group rg-backend-prod-eastus
   ```

3. **Fix issue and redeploy**:
   ```bash
   # Fix code
   atakora synth
   atakora deploy
   ```

### Incremental vs Complete Mode

**Use incremental (default)**:
- Safe for production
- Adds/updates resources
- Preserves existing resources

**Use complete carefully**:
- Deletes resources not in template
- Useful for exact state enforcement
- Requires caution and confirmation

```bash
# Safe
atakora deploy --mode incremental

# Dangerous - deletes resources!
atakora deploy --mode complete
```

## CI/CD Integration

### GitHub Actions

```yaml
name: Deploy Infrastructure

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Azure
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          atakora deploy \
            --package production \
            --no-confirm \
            --verbose
```

### Azure DevOps

```yaml
trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'

  - script: npm ci
    displayName: 'Install dependencies'

  - task: AzureCLI@2
    inputs:
      azureSubscription: 'Production'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        atakora deploy \
          --package production \
          --no-confirm \
          --verbose
    displayName: 'Deploy infrastructure'
```

### GitLab CI

```yaml
deploy:
  stage: deploy
  image: node:18
  before_script:
    - npm ci
  script:
    - |
      atakora deploy \
        --package production \
        --no-confirm \
        --verbose
  environment:
    name: production
  only:
    - main
```

## Rollback Strategy

Atakora doesn't have built-in rollback. Use these strategies:

### Version Control

Revert code and redeploy:

```bash
# Revert to previous commit
git revert HEAD

# Redeploy previous version
atakora synth
atakora deploy
```

### Manual Rollback

Use Azure Portal or CLI:

```bash
# List deployments
az deployment group list \
  --resource-group rg-backend-prod-eastus

# Redeploy previous template
az deployment group create \
  --name rollback-deployment \
  --resource-group rg-backend-prod-eastus \
  --template-file previous-template.json
```

### Blue-Green Deployment

Maintain separate environments:

```bash
# Deploy to blue environment
atakora deploy --package production-blue

# Test and verify

# Switch traffic to blue

# Deploy to green environment
atakora deploy --package production-green
```

## See Also

- [`atakora synth`](./synth.md) - Generate ARM templates
- [`atakora diff`](./diff.md) - Preview changes
- [`atakora config`](./config.md) - Configure credentials
- [Deployment Guide](../../guides/fundamentals/deployment.md)
- [Deployment Failures Troubleshooting](../../troubleshooting/deployment-failures.md)

---

**Last Updated**: 2025-10-08
**CLI Version**: 1.0.0+
