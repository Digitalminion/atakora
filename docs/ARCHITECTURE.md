# Azure ARM Priv - Architecture Guide

## Table of Contents

- [Overview](#overview)
- [Architecture Principles](#architecture-principles)
- [System Architecture](#system-architecture)
- [Package Structure](#package-structure)
- [Core Concepts](#core-concepts)
- [Construct Tree Pattern](#construct-tree-pattern)
- [Resource Hierarchy](#resource-hierarchy)
- [Naming System](#naming-system)
- [Synthesis Pipeline](#synthesis-pipeline)
- [Type System](#type-system)

## Overview

Azure ARM Priv is a TypeScript library for defining Azure infrastructure as code using a construct-based approach inspired by AWS CDK. The library provides type-safe, composable abstractions over Azure Resource Manager (ARM) templates.

## Architecture Principles

### 1. Type Safety First

- **Strict TypeScript**: All code uses strict TypeScript mode with no implicit `any` types
- **Schema-Driven**: Types are generated from official ARM JSON schemas
- **Compile-Time Validation**: Catch errors during development, not deployment

### 2. Construct Tree Pattern

- **Composability**: Resources are organized in a tree structure (borrowed from AWS CDK)
- **Hierarchical Context**: Properties flow down the tree (subscription, geography, naming)
- **Scoped Resources**: Each resource knows its scope and can resolve dependencies

### 3. Multi-Level Abstractions

```
┌─────────────────────────────────────────────────────┐
│ L3: Pattern Constructs                              │
│ - AuthR Infrastructure                            │
│ - Complete multi-tier architectures                 │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│ L2: Intent-Based Constructs                         │
│ - VirtualNetwork, ResourceGroup, StorageAccount     │
│ - Sensible defaults, auto-naming                    │
│ - High-level, developer-friendly API                │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│ L1: Low-Level ARM Constructs                        │
│ - ArmVirtualNetwork, ArmResourceGroup               │
│ - Direct mapping to ARM resources                   │
│ - Generated from ARM schemas                        │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│ ARM Templates (JSON)                                │
│ - Standard Azure Resource Manager templates         │
│ - Generated by synthesis pipeline                   │
└─────────────────────────────────────────────────────┘
```

### 4. Separation of Concerns

Each package has a clear responsibility:

- **@atakora/lib**: Core library with constructs, naming, synthesis
- **@atakora/cli**: Command-line interface for authentication and deployment
- **@atakora/color**: Reference implementation (AuthR infrastructure)

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         User Code                               │
│  import { App, SubscriptionStack, ResourceGroup } from 'lib'    │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Core Library (@atakora/lib)           │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Constructs │  │    Naming    │  │  Synthesis   │         │
│  │              │  │              │  │              │         │
│  │ - App        │  │ - Generator  │  │ - Traverser  │         │
│  │ - Stack      │  │ - Validator  │  │ - Collector  │         │
│  │ - Resources  │  │ - Conventions│  │ - Transformer│         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
│  ┌──────────────────────────────────────────────────┐          │
│  │          Generated Code (by Felix)               │          │
│  │  - ARM Schema Types                              │          │
│  │  - Validation Logic                              │          │
│  │  - L1 Constructs                                 │          │
│  └──────────────────────────────────────────────────┘          │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                  CLI (@atakora/cli)                      │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │     Auth     │  │    Config    │  │   Commands   │         │
│  │              │  │              │  │              │         │
│  │ - Azure Auth │  │ - Profiles   │  │ - synth      │         │
│  │ - Token Mgmt │  │ - Persistence│  │ - deploy     │         │
│  │              │  │              │  │ - diff       │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Azure Platform                             │
│  - Resource Manager (ARM)                                       │
│  - Azure Active Directory (Identity)                            │
│  - Subscription Management                                      │
└─────────────────────────────────────────────────────────────────┘
```

## Package Structure

### Monorepo Layout

```
atakora/
├── package.json                    # Root workspace config
├── tsconfig.base.json             # Shared TypeScript config
├── vitest.config.ts               # Test configuration
├── eslint.config.js               # Linting rules
├── .github/
│   └── workflows/
│       ├── ci.yml                 # Continuous integration
│       └── schema-sync.yml        # Daily schema updates
├── docs/                          # Documentation
│   ├── ARCHITECTURE.md            # This file
│   ├── NAMING_CONVENTIONS.md      # Naming guide
│   ├── ADDING_RESOURCES.md        # Resource development guide
│   ├── CI_CD_GUIDE.md            # CI/CD integration examples
│   └── BEST_PRACTICES.md         # Development best practices
├── packages/
│   ├── lib/                       # Core library
│   │   ├── src/
│   │   │   ├── core/             # Base constructs
│   │   │   ├── naming/           # Naming system
│   │   │   ├── synthesis/        # ARM template generation
│   │   │   ├── resources/        # Resource implementations
│   │   │   ├── codegen/          # Schema-driven code generation
│   │   │   ├── generated/        # Auto-generated types
│   │   │   └── examples/         # Usage examples
│   │   ├── package.json
│   │   └── vitest.config.ts
│   ├── cli/                       # CLI tool
│   │   ├── src/
│   │   │   ├── auth/             # Azure authentication
│   │   │   ├── config/           # Configuration management
│   │   │   └── commands/         # CLI commands
│   │   └── package.json
│   └── color/                     # Reference implementation
│       ├── src/
│       │   └── infrastructure/   # AuthR infrastructure
│       └── package.json
└── dist/                          # Build output
```

### Package Dependencies

```
@atakora/cli
    ↓ depends on
@atakora/lib
    ↓ depends on
constructs (external library)
```

## Core Concepts

### 1. App

The root of the construct tree. All infrastructure definitions start with an `App`.

```typescript
import { App } from '@atakora/lib';

const app = new App();
```

### 2. Stack

A deployment unit representing a scope within Azure (subscription or resource group).

**SubscriptionStack**: Deploys resources at subscription scope
**ResourceGroupStack**: Deploys resources within a resource group

```typescript
const stack = new SubscriptionStack(app, 'MyStack', {
  subscription: Subscription.fromId('...'),
  geography: Geography.fromValue('eastus'),
  organization: Organization.fromValue('digital-minion'),
  project: new Project('authr'),
  environment: Environment.fromValue('nonprod'),
  instance: Instance.fromNumber(1),
});
```

### 3. Context

Stacks carry context that flows to all child resources:

- **Subscription**: Azure subscription ID
- **Geography**: Azure region (eastus, westus2, etc.)
- **Organization**: Organization identifier (for naming)
- **Project**: Project name (for naming)
- **Environment**: Environment type (nonprod, production)
- **Instance**: Instance number (for multi-region deployments)
- **Tags**: Resource tags (inherited and merged)

### 4. Resources

All Azure resources extend the base `Resource` class:

```typescript
export abstract class Resource extends Construct {
  abstract readonly resourceType: string;
  abstract readonly resourceId: string;
  abstract readonly name: string;
  readonly location?: string;
  readonly tags?: Record<string, string>;
}
```

## Construct Tree Pattern

### Tree Structure

```
App
└── SubscriptionStack (Foundation)
    ├── ResourceGroup (NetworkRG)
    │   ├── VirtualNetwork (MainVNet)
    │   │   ├── Subnet (AppSubnet)
    │   │   └── Subnet (DataSubnet)
    │   └── NetworkSecurityGroup (AppNSG)
    └── ResourceGroup (ApplicationRG)
        ├── StorageAccount (AppStorage)
        └── KeyVault (AppKeyVault)
```

### Node Traversal

The construct tree can be traversed for various operations:

- **Synthesis**: Convert constructs to ARM templates
- **Validation**: Check naming rules, dependencies
- **Dependency Resolution**: Build deployment order
- **Resource Collection**: Gather all resources of a type

### Scoping Rules

1. **Parent-Child Relationship**: Resources are created within a scope
2. **Context Inheritance**: Child resources inherit context from parents
3. **Name Resolution**: Names are generated based on full scope path
4. **Tag Merging**: Tags merge down the tree (children override parents)

## Resource Hierarchy

### L1 Constructs (Low-Level)

Direct mappings to ARM resource types, generated from schemas.

**Naming**: Prefixed with `Arm` (e.g., `ArmResourceGroup`)
**Properties**: Match ARM template structure exactly
**Use Case**: Maximum control, explicit configuration

```typescript
new ArmResourceGroup(scope, 'MyRG', {
  resourceGroupName: 'rg-explicit-name',
  location: 'eastus',
  tags: { env: 'prod' },
});
```

### L2 Constructs (Intent-Based)

Developer-friendly abstractions with sensible defaults.

**Naming**: Plain resource names (e.g., `ResourceGroup`)
**Properties**: Simplified, high-level API
**Use Case**: Standard infrastructure patterns
**Features**:

- Auto-naming based on context
- Sensible defaults
- Validation
- Helper methods

```typescript
new ResourceGroup(stack, 'MyRG', {
  tags: { purpose: 'networking' },
});
// Name auto-generated: "rg-dp-authr-myrg-nonprod-eus-00"
```

### L3 Constructs (Pattern-Based)

Complete architecture patterns (future).

**Naming**: Pattern-specific (e.g., `AuthRInfrastructure`)
**Properties**: Very high-level, minimal configuration
**Use Case**: Standard reference architectures

## Naming System

See [NAMING_CONVENTIONS.md](./NAMING_CONVENTIONS.md) for detailed information.

### Key Features

- **Consistent**: All resources follow the same pattern
- **Context-Aware**: Uses stack context (org, project, env, geo, instance)
- **Type-Safe**: Validated at compile-time and runtime
- **Customizable**: Override conventions per stack or globally
- **Azure-Compliant**: Respects length limits and character restrictions

### Standard Pattern

```
{prefix}-{org}-{project}-{resource_id}-{environment}-{geography}-{instance}
```

Example: `rg-dp-authr-networkrg-nonprod-eus-00`

## Synthesis Pipeline

The synthesis pipeline converts the construct tree to deployable ARM templates.

### Pipeline Stages

```
┌─────────────────────────────────────────────────────────────┐
│ 1. PREPARE: Tree Traversal                                  │
│    - Walk construct tree depth-first                        │
│    - Collect all resources                                  │
│    - Build dependency graph                                 │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. VALIDATE: Pre-Synthesis Validation                       │
│    - Naming convention compliance                           │
│    - Resource limit checks                                  │
│    - Cross-resource validation                              │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. TRANSFORM: Resource Transformation                       │
│    - Convert constructs to ARM resources                    │
│    - Resolve dependencies                                   │
│    - Generate resource IDs                                  │
│    - Apply transformations                                  │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. ASSEMBLE: Template Assembly                              │
│    - Group resources by scope                               │
│    - Generate ARM template structure                        │
│    - Add parameters and variables                           │
│    - Include outputs                                        │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. EMIT: File Generation                                    │
│    - Write ARM template JSON files                          │
│    - Write parameter files                                  │
│    - Generate deployment scripts                            │
└─────────────────────────────────────────────────────────────┘
```

### Output Structure

```
arm.out/
├── foundation.template.json           # Subscription-level resources
├── foundation.parameters.json         # Parameter values
├── networkrg.template.json           # Resource group resources
├── networkrg.parameters.json
├── applicationrg.template.json
├── applicationrg.parameters.json
└── manifest.json                      # Deployment metadata
```

## Type System

### Schema-Driven Types

All ARM resource types are generated from official Azure ARM JSON schemas.

**Source**: [Azure/azure-resource-manager-schemas](https://github.com/Azure/azure-resource-manager-schemas)
**Generation**: Automated daily via GitHub Actions
**Validation**: Compile-time and runtime validation

### Type Generation Process

```
ARM Schema (JSON)
      ↓
Schema Parser
      ↓
Intermediate Representation (IR)
      ↓
Type Generator
      ↓
TypeScript Interfaces
```

### Generated Type Example

```typescript
/**
 * Properties for Microsoft.Storage/storageAccounts (L1 construct).
 *
 * ARM Resource Type: Microsoft.Storage/storageAccounts
 * API Version: 2023-01-01
 */
export interface ArmStorageAccountProps {
  /**
   * Storage account name
   *
   * Length: 3-24 characters
   * Pattern: ^[a-z0-9]+$
   */
  readonly name: string;

  /**
   * Resource location
   */
  readonly location: string;

  /**
   * Account SKU
   */
  readonly sku: StorageAccountSku;

  /**
   * Account kind
   */
  readonly kind: StorageAccountKind;

  // ... more properties
}
```

### Type Categories

1. **Resource Props**: Properties for constructing resources
2. **Enums**: String literal unions for valid values
3. **Complex Types**: Nested object structures
4. **ARM Templates**: Complete template structures

## Quality Standards

### Testing Requirements

- **Unit Tests**: All public APIs must have unit tests
- **Integration Tests**: Cross-package functionality tested
- **Coverage**: Minimum 80% code coverage
- **Test Organization**: Co-located with source files (`*.test.ts`)

### Type Safety

- **Strict Mode**: TypeScript strict mode enabled
- **No Any**: No implicit `any` types (explicit `any` requires justification)
- **JSDoc**: Public APIs must have comprehensive documentation
- **Type Exports**: All public types exported in `package.json`

### Code Quality

- **ESLint**: No warnings in production code
- **Prettier**: Consistent code formatting
- **Naming**: Clear, descriptive names following conventions
- **Error Messages**: Actionable guidance for users

## Architecture Decision Records (ADRs)

See the `docs/adr/` directory for detailed architecture decisions:

- ADR-001: Construct Tree Pattern
- ADR-002: Multi-Level Abstractions (L1, L2, L3)
- ADR-003: Schema-Driven Type Generation
- ADR-004: Naming Convention System
- ADR-005: Synthesis Pipeline Design

## Related Documentation

- [Naming Conventions Guide](./NAMING_CONVENTIONS.md)
- [Adding Resources Guide](./ADDING_RESOURCES.md)
- [CI/CD Integration Guide](./CI_CD_GUIDE.md)
- [Best Practices](./BEST_PRACTICES.md)
- [Code Generation README](../packages/lib/src/codegen/README.md)

---

**Maintained by**: Team Azure ARM Priv
**Last Updated**: 2025-10-04
